/*
* @Description: å…³é”®å¸§å°å·¥å…·,é€æ¸ä¸°å¯Œä¸­
* @Author: Bullet.S
* @Date: 2019-09-28 11:48:53
 * @LastEditors  : Bullet.S
 * @LastEditTime : 2019-12-23 11:35:31
* @Email: animator.bullet@foxmail.com
*/

try(destroydialog rolloutBulletKeyTools)catch()
try(destroydialog rolFnKeys)catch()
try(destroydialog rolAddMyScripts)catch()

struct myScript (id,msName,dir)

Global BulletConfig = execute ("@\"" + (getDir #maxData) + "\\BulletConfig.ini\"")  --é…ç½®æ–‡ä»¶è·¯å¾„
Global iniPos  	--ä½ç½®ä¿å­˜è®°å½•
Global iniHelpBtn        = off--è®°å½•æ˜¯å¦æ‰“å¼€å¸®åŠ©æ¨¡å¼
Global iniArrMyScripts   = #()
Global idBtn             = 1
Global posMouX           = mouse.screenpos.x
Global posMouY           = mouse.screenpos.y  --è·å–é¼ æ ‡ä½ç½®
Global posMouMoved       = [0,0]
Global posToolBtn        = [205,45]
Global switchMouseState  = false
Global switchSelKeyRange = 0
Global switchHideBones   = 0
Global switchHideBiped   = 0
Global switchToolPanel   = 0
Global arrLastSelRange   = #()
Global switchAllKeyRange = 0
Global arrLastAllRange   = #()
Global arrKeysTime       = #()  ----------bipedå’Œboneçš„é¦–å°¾å¸§
Global arrLinkKeys       = #()  -----------å­˜linkå¸§
Global arrKeysSelected   = #()  -----------å­˜é€‰ä¸­çš„å¸§
Global keyFirst
Global keyEnd
Global keySelFirst
Global keySelEnd
Global fnFindFirstEndKey
Global fnAddKyes
Global fnSelectKeys
Global fnSelLinkKeys
Global fnAddLinkTimesKeys
Global fnAddLinkParamsKeys
Global keyMovedOffset = 5
Global symbol ----é€‰æ‹©çš„èŒƒå›´åˆ¤æ–­, 0å·¦è¾¹,1å³è¾¹,2å…¨éƒ¨
Global layerTraj --è½¨è¿¹è¾…åŠ©å±‚
Global arrTraj            = #()  ---è½¨è¿¹å­˜æ”¾æ•°ç»„, æ–¹ä¾¿åˆ é™¤
Global arrTempBones       = #()  ---éšè—éª¨éª¼ä¸´æ—¶å­˜æ”¾æ•°ç»„
Global arrTempBiped       = #()  ---éšè—éª¨éª¼ä¸´æ—¶å­˜æ”¾æ•°ç»„
Global arrTempUnSelection = #()  ---éšè—æœªé€‰ä¸­ä¸´æ—¶å­˜æ”¾æ•°ç»„
Global arrToolC1          = #()  ----------å·¥å…·æŒ‰é’®æ•°ç»„
Global arrToolC2          = #()  ----------å·¥å…·æŒ‰é’®æ•°ç»„
Global arrToolC3          = #()  ----------å·¥å…·æŒ‰é’®æ•°ç»„
Global arrToolC4          = #()  ----------å·¥å…·æŒ‰é’®æ•°ç»„
Global arrToolC5          = #()  ----------å·¥å…·æŒ‰é’®æ•°ç»„
Global uiClientOffsets = undefined
Global rolloutBulletKeyTools
Global menuSetFps
Global menuSetSpeed
-- Global myTimer = dotnetobject "System.Timers.Timer" 500 autoreset:true
------------------å…¨å±€å˜é‡-------------------------------------------------------------------

fn fnGetConfig attr nameAttrClass nameAttr valueAttr =  --è®¾ç½®åˆå§‹ä¿¡æ¯æ–¹æ³•
(
	attr = (GetINISetting BulletConfig nameAttrClass nameAttr) as string  --å…ˆæå–æ–‡ä»¶ä¸­çš„è®°å½•
	if (nameAttr == "ArrMyScripts")then
	(
		attr = substituteString attr "dir:" "dir:@"
	)
	if attr == "" then attr = (execute valueAttr) else (attr = execute attr)  --åˆ¤æ–­è®°å½•ä¸ºç©ºä¸å¦å¾—åˆ°éœ€è¦çš„è®°å½•å‚æ•°
)
fn fnSaveConfig =  --å¼•ç”¨ä¸Šé¢æ–¹æ³•æå‡ºéœ€è¦çš„å‚æ•°
(----æå‡ºè„šæœ¬ä½ç½®
	iniPos          = fnGetConfig iniPos "BulletKeyToolsSet" "Pos" ([posMouX,posMouY] as string)
	switchToolPanel = fnGetConfig switchToolPanel "BulletKeyToolsSet"  "ToolPanel" (switchToolPanel as string)
	idBtn           = fnGetConfig idBtn "BulletKeyToolsSet"  "idBtn" (idBtn as string)
	iniArrMyScripts = fnGetConfig iniArrMyScripts "BulletKeyToolsSet"  "ArrMyScripts" (iniArrMyScripts as string)
	iniHelpBtn      = fnGetConfig iniHelpBtn "BulletKeyToolsSet"  "HelpBtn" (iniHelpBtn as string)
)
fnSaveConfig () --åˆå§‹æ‰§è¡Œä¸€é
fn fnSetConfig =  --ä¿å­˜å‚æ•°,è„šæœ¬ä½ç½®
(
	SetINISetting BulletConfig "BulletKeyToolsSet"  "Pos" (iniPos as string)
	SetINISetting BulletConfig "BulletKeyToolsSet"  "ToolPanel" (switchToolPanel as string)
	SetINISetting BulletConfig "BulletKeyToolsSet"  "idBtn" (idBtn as string)
	SetINISetting BulletConfig "BulletKeyToolsSet"  "ArrMyScripts" (iniArrMyScripts as string)
	SetINISetting BulletConfig "BulletKeyToolsSet"  "HelpBtn" (iniHelpBtn as string)
)
---------------é…åˆBulletToolså·¥å…·çš„iniæ–‡ä»¶ä¿å­˜ä½ç½®ä¿¡æ¯-----------------

-------------------å¸§ç‡,æ’­æ”¾é€Ÿåº¦--------------------------------------------------------------
Global valueFps
Global valuePlaySpeed = ""
Global strCurrentFps = framerate as string + " FPS"

rollout rolCustomFps ""
(
	edittext edtFpsValue "FPS: "  pos:[10,10] width:60 usePercentageWidth:true \
	percentageWidth:44.0 labelOnTop:false text:"60" bold:true readOnly:false --å¸§ç‡æ•°å€¼
	button btnSetFps "Set" pos:[80,8]
	label labTips strCurrentFps

	on rolCustomFps open do 
	(
		edtFpsValue.text = framerate as string
		labTips.text = "å½“å‰å¸§ç‡: " + framerate as string + " FPS"
		valueFps = framerate as integer
	)

	on edtFpsValue entered val do 
	(
		if ((val != ".") and (val as integer != undefined) and (val != "") and (val as integer >= 0)) then
		(
			valueFps = (val as integer)
		)
		else messagebox "---------------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§ç‡æ•°å€¼\r\n"
	)
	on btnSetFps pressed do 
	(
		framerate = valueFps
		labTips.text = "å½“å‰å¸§ç‡: " + framerate as string + " FPS"
		slidertime -= 1
		slidertime += 1
	)
)

fn fnSetFps numFps =
(
	framerate = numFps
	valueFps = numFps
	strCurrentFps = numFps as string + " FPS"
	rolloutBulletKeyTools.btnSetFpsAndSpeed.text = " |  " + strCurrentFps + "  | " + valuePlaySpeed + " |"
	slidertime -= 1
	slidertime += 1
)

fn fnRefFps =
(
	local arrMenuSetFps = #(menuSetFps.menuSet60Fps,menuSetFps.menuSet30Fps, \
							menuSetFps.menuSet24Fps,menuSetFps.menuCustomFps)
	for i in arrMenuSetFps do i.checked = false
	case of
	(
		(framerate == 60):(menuSetFps.menuSet60Fps.checked = true)
		(framerate == 30):(menuSetFps.menuSet30Fps.checked = true)
		(framerate == 24):(menuSetFps.menuSet24Fps.checked = true)
		default:(menuSetFps.menuCustomFps.checked = true)
	)
)

fn fnRefPlaySpeedValue =
(
	local arrMenuSetSpeed = #(menuSetSpeed.menuSet14Speed,menuSetSpeed.menuSet12Speed, \
		menuSetSpeed.menuSet1Speed,menuSetSpeed.menuSet2Speed,menuSetSpeed.menuSet4Speed)
		for i in arrMenuSetSpeed do i.checked = false
	case of
	(
		(timeConfiguration.playbackSpeed == 1):(valuePlaySpeed = "--1/4x--";menuSetSpeed.menuSet14Speed.checked =true)
		(timeConfiguration.playbackSpeed == 2):(valuePlaySpeed = "--1/2x--";menuSetSpeed.menuSet12Speed.checked =true)
		(timeConfiguration.playbackSpeed == 3):(valuePlaySpeed = "-- 1x --";menuSetSpeed.menuSet1Speed.checked =true)
		(timeConfiguration.playbackSpeed == 4):(valuePlaySpeed = "-- 2x --";menuSetSpeed.menuSet2Speed.checked =true)
		(timeConfiguration.playbackSpeed == 5):(valuePlaySpeed = "-- 4x --";menuSetSpeed.menuSet4Speed.checked =true)
	)
)

fn fnSetSpeed numSpeed =
(
	timeConfiguration.playbackSpeed = numSpeed
	fnRefPlaySpeedValue ()
	rolloutBulletKeyTools.btnSetFpsAndSpeed.text = " |  " + strCurrentFps + "  | " + valuePlaySpeed + " |"
)

rcmenu menuSetFps
(
	menuItem menuCurrentFps "" enabled:false
	menuItem menuSet60Fps "-- 60 Fps --"
	menuItem menuSet30Fps "-- 30 Fps --"
	menuItem menuSet24Fps "-- 24 Fps --"
	separator menuSepCustom
	menuItem menuCustomFps "è‡ªå®šä¹‰å¸§ç‡"

	on menuSetFps open do 
	(
		strCurrentFps = framerate as string + " FPS"
		fnRefPlaySpeedValue ()
		menuSetFps.menuCurrentFps.text = "å½“å‰å¸§ç‡: " + framerate as string + " FPS"
		fnRefFps ()
		rolloutBulletKeyTools.btnSetFpsAndSpeed.text = " |  " + strCurrentFps + "  | " + valuePlaySpeed + " |"
	)

	on menuSet60Fps picked do 
	(
		fnSetFps 60
	)
	on menuSet30Fps picked do
	(
		fnSetFps 30
	)
	on menuSet24Fps picked do 
	(
		fnSetFps 24
	)

	on menuCustomFps picked do
	(
		try (destroyDialog rolCustomFps) catch()
		createdialog rolCustomFps 120 55 fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)
)

rcmenu menuSetSpeed
(
	menuItem menuCurrentSpeed "" enabled:false
	menuItem menuSet14Speed "-- 1/4x --"
	menuItem menuSet12Speed "-- 1/2x --"
	separator menuSepSpeedLow
	menuItem menuSet1Speed "--  1x  --"
	separator menuSepSpeedHigh
	menuItem menuSet2Speed "--  2x  --"
	menuItem menuSet4Speed "--  4x  --"

	on menuSetSpeed open do 
	(
		strCurrentFps = framerate as string + " FPS"
		fnRefPlaySpeedValue ()
		menuSetSpeed.menuCurrentSpeed.text = "å½“å‰æ’­é€Ÿ: " + valuePlaySpeed
		rolloutBulletKeyTools.btnSetFpsAndSpeed.text = " |  " + strCurrentFps + "  | " + valuePlaySpeed + " |"
	)

	on menuSet14Speed picked do 
	(
		fnSetSpeed 1
	)
	on menuSet12Speed picked do
	(
		fnSetSpeed 2
	)
	on menuSet1Speed picked do 
	(
		fnSetSpeed 3
	)
	on menuSet2Speed picked do 
	(
		fnSetSpeed 4
	)
	on menuSet4Speed picked do 
	(
		fnSetSpeed 5
	)
)
------------------å¸§ç‡,æ’­æ”¾é€Ÿåº¦------------------------------------------------------------
rollout rolAddMyScripts "æˆ‘çš„è„šæœ¬" width:250 height:190
(
	label lblRename "â†“è¯·è¾“å…¥é‡å‘½åâ†“" pos:[20,5]
	label lblReDir "â†“æŒ‡å®šè·¯å¾„â†“" pos:[125,5]
	label lblTips "â†“æ³¨æ„â†“" pos:[205,5]
	edittext edtRenameMs1 " 1 "  pos:[5,25] width:100 height:20 text:""
	button btnReAddMs1 "..."  pos:[115,25] width:80 height:20 border:true
	edittext edtRenameMs2 " 2 "  pos:[5,60] width:100 height:20 text:""
	button btnReAddMs2 "..."  pos:[115,60] width:80 height:20 border:true
	edittext edtRenameMs3 " 3 "  pos:[5,95] width:100 height:20 text:""
	button btnReAddMs3 "..."  pos:[115,95] width:80 height:20 border:true
	edittext edtRenameMs4 " 4 "  pos:[5,130] width:100 height:20 text:""
	button btnReAddMs4 "..."  pos:[115,130] width:80 height:20 border:true
	button btnDoit "ç¡®è®¤" pos:[205,25] width:35 height:125 border:true
	button btnClearMyScripts "! æ¸…é™¤æ‰€æœ‰è„šæœ¬å¼•ç”¨ !" pos:[5,160] width:240 height:25 border:true

	fn fnRefreshBtnReAddMs btnMsName btnMsDir id =
	(
		dirScript = getOpenFileName caption:"è¯·é€‰æ‹©æ·»åŠ çš„Maxè„šæœ¬:" historyCategory:"myScripts" \
		types:"ms(*.ms)|*.ms|mse(*.mse)|*.mse|All(*.*)|*.*" filename:(getDir #scripts + @"\") 
		if (dirScript != undefined) then
		(
			nameMyScript = getFilenameFile dirScript
			btnMsName.text = nameMyScript
			btnMsDir.text = "å·²ä¿®æ”¹"
			if iniArrMyScripts[id] != undefined then iniArrMyScripts[id].dir = dirScript
			else
			(
				append iniArrMyScripts (myScript id edtRenameMs1.text dirScript)
			)
		)
		-- print dirScript
	)

	fn fnAddMsName id edtRenameMs =
	(
		if (iniArrMyScripts[id] != undefined) then
		(
			if edtRenameMs.text != "" then iniArrMyScripts[id].msName = edtRenameMs.text
			else iniArrMyScripts[id].msName = "<æœªå‘½åè„šæœ¬>"
		)
	)

	fn fnRefreshMyScriptsUI =
	(
		local tempArrBtn = #(rolAddMyScripts.edtRenameMs1,rolAddMyScripts.edtRenameMs2, \
							rolAddMyScripts.edtRenameMs3,rolAddMyScripts.edtRenameMs4)

		for b = 1 to tempArrBtn.count do
		(
			if iniArrMyScripts[b] != undefined then
			(
				if iniArrMyScripts[b].msName != undefined then 
				(
					tempArrBtn[b].text = iniArrMyScripts[b].msName 
				)
				else tempArrBtn[b].text = ""
			)
		)
	)

	fn fnClearMyScripts = --æ¸…é™¤è„šæœ¬
	(
		--è®¾ç½®dotNetçª—å£å…ƒç´ 
		local mb = dotNetClass "System.Windows.Forms.MessageBox"
		local buttons = dotNetClass "System.Windows.Forms.MessageBoxButtons"
		local icons = dotNetClass "System.Windows.Forms.MessageBoxIcon"
		local defaultButton = dotNetClass "System.Windows.Forms.MessageBoxDefaultButton"
		local dialogResult = dotNetClass "System.Windows.Forms.DialogResult"

		local result = mb.show "ç¡®å®šæ¸…é™¤4ä¸ªå¼•ç”¨çš„è„šæœ¬æŒ‰é’®å— ?" "è‡ªå®šè„šæœ¬ä¸€é”®æ¸…é™¤" buttons.YesNoCancel icons.Information defaultButton.Button3

		--é€‰é¡¹æŒ‰é’®
		if ( result == dialogResult.Yes ) then
		(
			iniArrMyScripts = #()
			arrMyScriptTemp = #(rolloutBulletKeyTools.btnMyScripts1,rolloutBulletKeyTools.btnMyScripts2,rolloutBulletKeyTools.btnMyScripts3,rolloutBulletKeyTools.btnMyScripts4)
			for b = 1 to 4 do 
			(
				arrMyScriptTemp[b].text = "< ï¼‹ï¼‹ï¼‹ >"
			)
		)
		else if ( result == dialogResult.No ) then
		(
			format "NO\n"
		)
		else if ( result == dialogResult.Cancel ) then
		(
			format "CANCEL\n"
		)
	)

	on rolAddMyScripts open do 
	(
		fnRefreshMyScriptsUI ()
	)

	on btnReAddMs1 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs1 btnReAddMs1 1
	)

	on btnReAddMs2 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs2 btnReAddMs2 2
	)

	on btnReAddMs3 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs3 btnReAddMs3 3
	)

	on btnReAddMs4 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs4 btnReAddMs4 4
	)

	on edtRenameMs1 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs1.text = tempText
	)

	on edtRenameMs2 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs2.text = tempText
	)

	on edtRenameMs3 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs3.text = tempText
	)

	on edtRenameMs4 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs4.text = tempText
	)

	on btnDoit pressed do
	(
		fnAddMsName 1 edtRenameMs1
		fnAddMsName 2 edtRenameMs2
		fnAddMsName 3 edtRenameMs3
		fnAddMsName 4 edtRenameMs4

		arrMyScriptTemp = #(rolloutBulletKeyTools.btnMyScripts1,rolloutBulletKeyTools.btnMyScripts2,rolloutBulletKeyTools.btnMyScripts3,rolloutBulletKeyTools.btnMyScripts4)
		for b = 1 to 4 do 
		(
			if iniArrMyScripts[b] != undefined then
			(
				if (iniArrMyScripts[b].msName != undefined) then 
				(
					arrMyScriptTemp[b].text = iniArrMyScripts[b].msName
				)
			)
		)
	)

	on btnClearMyScripts pressed do 
	(
		fnClearMyScripts ()
	)
)
---------------------æ»‘åŠ¨å¸§åˆ‡æ¢rollout---------------------------------
rollout rolFnKeys "æ»‘åŠ¨å¸§åˆ‡æ¢ v1.1" width:280 height:120
(
	group ""
	(
		checkbox chkLHand "å·¦æ‰‹" pos:[24,20] width:50 height:20 color:Blue
		checkbox chkRHand "å³æ‰‹" pos:[96,20] width:50 height:20 color:Green
		checkbox chkLFoot "å·¦è„š" pos:[24,55] width:50 height:20 color:Blue checked:true
		checkbox chkRFoot "å³è„š" pos:[96,55] width:50 height:20 color:Green checked:true
		button btnPlanted "å›ºå®šå…³é”®å¸§" pos:[184,20] width:80 height:25 toolTip:"Set Planted Key"
		button btnSliding "æ»‘åŠ¨å…³é”®å¸§" pos:[184,50] width:80 height:25 toolTip:"Set Sliding Key"
		button btnFree "è‡ªç”±å…³é”®å¸§" pos:[184,80] width:80 height:25 toolTip:"Set Free Key"
		label lblMe "[2019.05.28]  Bullet.S" pos:[24,92] width:120 height:16 color:Green
	)
	
	Fn fnSetKeyType keyType = 
	(
		sliderTime = animationRange.start
		for obj in selection where ((classof obj.baseObject == Biped_Object) \
		and (biped.getCurrentLayer obj.controller == 0)) do
		(
			bipCtrl = obj.controller
			if chkLHand.checked then 
			(
				sel_obj1 = (biped.getNode bipCtrl #larm)
				k = numKeys sel_obj1.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj1.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj1)
								(keyType == 2):(biped.SetSlidingKey sel_obj1)
								(keyType == 3):(biped.SetFreeKey sel_obj1)
							)
						)
					)
			)
			if chkRHand.checked then 
			(
				sel_obj2 = (biped.getNode bipCtrl #rarm)
				k = numKeys sel_obj2.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj2.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj2)
								(keyType == 2):(biped.SetSlidingKey sel_obj2)
								(keyType == 3):(biped.SetFreeKey sel_obj2)
							)
						)
					)
			)
			if chkLFoot.checked then 
			(
				sel_obj3 = (biped.getNode bipCtrl #lleg)
				k = numKeys sel_obj3.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj3.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj3)
								(keyType == 2):(biped.SetSlidingKey sel_obj3)
								(keyType == 3):(biped.SetFreeKey sel_obj3)
							)
						)
					)
			)
			if chkRFoot.checked then 
			(
				sel_obj4 = (biped.getNode bipCtrl #rleg)
				k = numKeys sel_obj4.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj4.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj4)
								(keyType == 2):(biped.SetSlidingKey sel_obj4)
								(keyType == 3):(biped.SetFreeKey sel_obj4)
							)
						)
					)
			)
		)
	)
	
	on btnPlanted pressed  do
	(
		fnSetKeyType 1
	)
	
	on btnSliding pressed  do
	(
		fnSetKeyType 2
	)
	
	on btnFree pressed  do
	(
		fnSetKeyType 3
	)
)
-----------------------------------------------------------------

-------------ä¸»UI-----------------------------------------------------------------
rollout rolloutBulletKeyTools "" width:200 height:235
(
	---------------------------------UI--------------------------------------
	groupbox gbxMainUI "[ AnimBullet _ v0.8.5 ] -- ä¸­é”®å…³é—­" pos:[5,5] width:190 height:195
	
		label lblRangeTimeText "| èµ·å§‹å¸§ |      | ç»“æŸå¸§ |" pos:[10,25] width:180 \
		spinner spiStartTime "" pos:[10,45] width:50 type:#integer \
		range:[-999999999,999999999,animationrange.start] scale:1
		label lblTo "â–ƒ"  pos:[65,41] tooltip:"æ•´æ•°å°æ•°å¸§åˆ‡æ¢,\r\nå¹³æ»‘æ‹–å¸§çœ‹å¡é¡¿" \
		width:20 height:20
		spinner spiEndTime "" pos:[80,45] width:50 type:#integer \
		range:[-999999999,999999999,animationrange.end] scale:1
		-- checkbutton ckbHelpBtn "ï¼Ÿè§‰é†’" pos:[135,23] width:55 height:20 border:false \
		-- tooltip:"æ‰“å¼€å¸®åŠ©æ¨¡å¼ï¼"
		button btnMagicBtn "âœ§(â‰– â—¡ â‰–" pos:[135,26] width:55 height:35 border:false \
		tooltip:"ç‚¹æˆ‘ç‚¹æˆ‘ç‚¹æˆ‘~è‰¯å¿ƒå°å·¥å…·"
		edittext edtMoveKey "ç§»åŠ¨" width:70 usePercentageWidth:true percentageWidth:44.0 \ 
		pos:[10,70] labelOnTop:false text:"5f" bold:true readOnly:false 
		button btnSet5 "5f" width:35 pos:[90,67]
		button btnSetAdd "+5f" width:35 pos:[125,67]
		button btnSetOpposite "è´Ÿ" width:30 pos:[160,67]
		checkBox btnJudgeLinkKey "Link?" \
		pos:[18,102] tooltip:"æ˜¯å¦å­˜åœ¨Linkå¸§?" checked:false 
		button btnSelBeforeKeys " " \
		pos:[70,93] width:30 height:30 toolTip:"é€‰æ‹©æ»‘æ¡å‰é¢å…³é”®å¸§" border:false
		button btnSelAllKeys " " \
		pos:[100,93] width:30 height:30 toolTip:"é€‰æ‹©æ‰€æœ‰å…³é”®å¸§" border:false
		button btnSelAfterKeys " " \
		pos:[130,93] width:30 height:30 toolTip:"é€‰æ‹©æ»‘æ¡åé¢å…³é”®å¸§" border:false
		button btnMoveKeys " " width:30 height:30 \
		pos:[160,93] toolTip:"ç§»åŠ¨å…³é”®å¸§,å…ˆå·¦è¾¹é€‰å¸§\r\nå·¦ï¼šå¸§æ èŒƒå›´ä¿æŒä¸å˜~\r\nå³ï¼šå¸§æ èŒƒå›´åŒæ­¥å¢å‡~" border:false
		checkbutton ckbFnBoxDisplay "ğŸ“¦ BOX" width:42 height:23 border:false \
		toolTip:"éª¨éª¼åˆ‡æ¢Boxæ˜¾ç¤º" pos:[10,125]
		checkbutton ckbFreezeMesh "â„ï¸ å†»ç»“æ¨¡å‹" width:68 height:23 border:false \
		toolTip:"å†»ç»“è§£å†»æ¨¡å‹" pos:[52,125]
		button btnHideBones "â›…ï¸ éšè—éª¨éª¼" width:70 height:23 border:false \
		toolTip:"å·¦ï¼šéšè— bone\r\nå³ï¼šéšè— biped" pos:[120,125]
		button btnFileOpen "ğŸ å¿«é€Ÿæ‰“å¼€ " pos:[10,149] width:70 height:23 \
		tooltip:"å¿«é€Ÿæ‰“å¼€maxæ–‡ä»¶\r\nå¯æ”¶è—å¸¸ç”¨ç›®å½•" border:false
		button btnCutFrameDisplay "ğŸ¹ å¸§é¢„è§ˆ" pos:[80,149] width:60 height:23 \
		tooltip:"å·¦ï¼šé¢„è§ˆé€‰æ‹©å¸§èŒƒå›´\r\nå³ï¼šé¢„è§ˆå…¨éƒ¨å¸§èŒƒå›´\r\nå†ç‚¹å›åˆ°ä¸Šæ¬¡å¸§èŒƒå›´\r\nåˆ«æ™ƒæ™•äº†ã€‚â•®(ï¿£â–½ï¿£)â•­" border:false
		button btnSpringMagic "ğŸ’ é£˜å¸¦" pos:[140,149] width:50 height:23 \
		tooltip:"å·¦ç‚¹æ–°ç‰ˆ,å³ç‚¹æ—§ç‰ˆ" border:false
		button btnQuickSave "ğŸ’£ å¤‡ä»½|å¦å­˜" pos:[10,173] width:70 height:23 \
		toolTip:"å·¦ï¼šå¿«é€Ÿå¤‡ä»½\r\nå³ï¼šå¦å­˜æ–‡ä»¶" border:false
		button btnSetFpsAndSpeed " " pos:[80,173] width:110 height:23 \
		toolTip:"å·¦ï¼šè®¾ç½®å¸§ç‡\r\nå³ï¼šæ’­æ”¾é€Ÿåº¦" border:false
	
	groupbox gbxMinTools "" pos:[200,5] width:160 height:225
	
		checkbutton ckbC1 "å¸§" width:38 height:26 \
		pos:[205,15] toolTip:""
		checkbutton ckbC2 "æ˜¾" width:37 height:26 \
		pos:[243,15] toolTip:""
		checkbutton ckbC3 "é€‰" width:37 height:26 \
		pos:[280,15] toolTip:""
		checkbutton ckbC4 "éª¨" width:38 height:26 \
		pos:[317,15] toolTip:""
		-- checkbutton ckbC5 "ä¹±" width:30 height:25 \
		-- pos:[325,15] toolTip:""

		button btnBoneTraj "ã€½ï¸ æ˜¾ç¤º | æ¸…é™¤ Boneè½¨è¿¹" width:150 height:30   visible:false \
		toolTip:"å·¦ï¼šåˆ‡æ¢æ˜¾ç¤ºBoneè½¨è¿¹,\r\nå³ï¼šæ¸…é™¤æ‰€æœ‰Boneè½¨è¿¹"
		button btnBipedTraj "ã€°ï¸ å•åŠ  | æ¸…é™¤ Bipedè½¨è¿¹" width:150 height:30   visible:false \
		toolTip:"å·¦ï¼šåˆ‡æ¢æ˜¾ç¤ºå•ä¸ªBipedè½¨è¿¹,\r\nå³ï¼šæ¸…é™¤æ·»åŠ çš„æ‰€æœ‰Bipedè½¨è¿¹~"
		button btnFnFrame "ğŸ’¬  æ•´æ•°å°æ•°å¸§åˆ‡æ¢        " width:150 height:30   visible:false \
		tooltip:"æ•´æ•°å°æ•°å¸§åˆ‡æ¢,\r\nå¹³æ»‘æ‹–å¸§çœ‹å¡é¡¿"
		button btnSelByColor "ğŸ’Š  ä»¥åŒé¢œè‰²é€‰æ‹©     " width:150 height:30   visible:false \
		tooltip:"é€‰æ‹©åŒé¢œè‰²ç‰©ä½“"
		button btnFnTCB "ğŸ”„   Euler  |  TCB äº’è½¬" width:150 height:30   visible:false \
		tooltip:"æ¬§æ‹‰å’ŒTCBäº’è½¬"
		button btnEulerFilter "ğŸ’¢   æ¬§æ‹‰æ›²çº¿è¿‡æ»¤    " width:150 height:30   visible:false \
		tooltip:"Boneéª¨éª¼è¿‡æ»¤æ¬§æ‹‰æ—‹è½¬"
		button btnBoneTool " ğŸ—  BoneOn å¼€å…³åˆ‡æ¢" width:150 height:30   visible:false \
		tooltip:"éª¨éª¼BoneOnåˆ‡æ¢"
		button btnNull1 "ğŸ””å¾…æ·»åŠ " width:150 height:30   visible:false \
		tooltip:""
		-- button btnClearSelKeys "â–² å–æ¶ˆé€‰æ‹©å¸§" width:150 height:30   visible:false \
		-- tooltip:"å–æ¶ˆå…³é”®å¸§é€‰æ‹© (éåˆ é™¤å¸§)"
		button btnDelOutKeys " âœ–ï¸ åˆ é€‰ä¸­ | æ‰€æœ‰å¸§" width:150 height:30   visible:false \
		toolTip:"å·¦ï¼šæ¸…é™¤é€‰æ‹©\r\nå³ï¼šæ¸…é™¤æ‰€æœ‰å¸§\r\nLinkå¸§è¯·æ‰‹åŠ¨åˆ ~"
		button btnCleanOutKeys "ğŸš«  æ¸…èŒƒå›´å¤–å…³é”®å¸§ " width:150 height:30   visible:false \
		toolTip:"æ¸…èŒƒå›´å¤–å¸§(æ— é™å¸§)"
		button btnHideUnSel "âœ³ï¸  éšè—å½“å‰æœªé€‰ä¸­ç‰©ä½“" width:150 height:30   visible:false \
		toolTip:"éšè—å½“å‰æ˜¾ç¤ºçš„æœªé€‰ä¸­ç‰©ä½“ï¼Œå¯å†é‡æ–°æ˜¾ç¤º"
		button btnSelBoneBiped "â˜‘ï¸  Biped | Bone é€‰æ‹©" width:150 height:30   visible:false \
		toolTip:"å·¦ï¼šé€‰æ‹©æ‰€æœ‰biped\r\nå³ï¼šé€‰æ‹©æ‰€æœ‰bone"
		button btnEndBone "â•  æ¸…é™¤ | æ·»åŠ   æœ«ç«¯" width:150 height:30   visible:false \
		toolTip:"æ¸…é™¤æ·»åŠ Boneæœ«ç«¯"
		button btnQuickPrev "ğŸ¥ å¿«é€Ÿæ‹å± | æ‰“å¼€ç›®å½• " width:150 height:30   visible:false \
		toolTip:"å·¦ï¼šå¿«é€Ÿæ‹å±é¢„è§ˆ\r\nå³ï¼šæ‰“å¼€é¢„è§ˆæ–‡ä»¶å¤¹"
		button btnFastAlign "ğŸŒ å¿«é€Ÿå¯¹é½å·¥å…·  " width:150 height:30   visible:false \
		toolTip:"åŠŸèƒ½å¾…æ·»åŠ "
		button btnFnKeyType "ğŸ“  æ‰¹é‡æ”¹æ»‘åŠ¨å¸§  " width:150 height:30   visible:false \
		toolTip:"æ‰¹é‡è½¬æ¢æ»‘åŠ¨å…³é”®å¸§ç­‰,\r\nåç»­å¯èƒ½æŒ‰éœ€ä¼˜åŒ–æ›´å¤šè®¾ç½®"
		button btnCopyKeyTools "âš¡ï¸ æš´åŠ›ç²˜è´´å·¥å…·  " width:150 height:30   visible:false \
		toolTip:"ç›®å‰å¼•ç”¨å‡é±¼å¤§ä½¬çš„æ’ä»¶\r\nåé¢éšç¼˜æ–°å†™æˆ–ä¼˜åŒ–"
		button btnAnimMirror "ğŸ”° åŠ¨ç”»é•œåƒå·¥å…·  " width:150 height:30   visible:false \
		toolTip:"ç›®å‰å¼•ç”¨4698toå¤§ä½¬çš„æ’ä»¶\r\nåé¢éšç¼˜æ–°å†™æˆ–ä¼˜åŒ–"
		checkbutton ckbFnMtlDisplay "ğŸ’¡  ç™½æ¨¡ | çº¢æ¨¡æè´¨åˆ‡æ¢ " width:150 height:30   visible:false \
		toolTip:"å·¦:åˆ‡æ¢æ˜¾ç¤ºéšè—è´´å›¾,æ–¹ä¾¿ç™½æ¨¡é¢„è§ˆ\r\nå³:Clayæ˜¾ç¤ºå¼€å…³\r\næ³¨æ„ï¼šæš‚ä¸æ”¯æŒå­æè´¨å’ŒVrayæè´¨..."
		button btnCSTools "ğŸš¹  CS é€‰æ‹©å·¥å…·       " width:150 height:30   visible:false \
		toolTip:"å¿«é€Ÿé€‰æ‹©CSéª¨éª¼\r\nå³é”®æ·»åŠ æˆ–è§£é™¤è‡ªå¯"
		button btnCutSequence "âœ‚ï¸  åŠ¨ç”»ç‰‡æ–­è®°å½•    " width:150 height:30   visible:false \
		toolTip:"åŠŸèƒ½å¾…æ·»åŠ "
		button btnPoseTool "ğŸš»   Pose åº“å­˜å–       " width:150 height:30   visible:false \
		toolTip:"åŠŸèƒ½å¾…æ·»åŠ "
		button btnMopherSlider "ğŸ˜  è¡¨æƒ…æ»‘æ¡             " width:150 height:30   visible:false \
		toolTip:"é€‰æ‹©å¸¦morpherçš„meshï¼Œ\r\næ‰“å¼€å¿«é€Ÿè°ƒèŠ‚æ»‘æ¡æ–¹ä¾¿Kè¡¨æƒ…~"
		button btnNull2 "ğŸ””å¾…æ·»åŠ " width:150 height:30   visible:false \
		toolTip:"CSç¼©æ”¾æ·»åŠ æ¸…é™¤ï¼ˆé¡¹ç›®æ…ç”¨ï¼‰"
	
	-- groupbox gbxMyScripts "" pos:[5,230] width:335 height:45

		button btnMyScripts1 "< ï¼‹ï¼‹ï¼‹ >" pos:[5,232] width:85 height:20 border:true
		button btnMyScripts2 "< ï¼‹ï¼‹ï¼‹ >" pos:[95,232] width:85 height:20 border:true
		button btnMyScripts3 "< ï¼‹ï¼‹ï¼‹ >" pos:[185,232] width:85 height:20 border:true
		button btnMyScripts4 "< ï¼‹ï¼‹ï¼‹ >" pos:[275,232] width:85 height:20 border:true
		-- button btnMyScripts5 "< ï¼‹ï¼‹ï¼‹ >" pos:[290,232] width:70 height:20 border:true

	groupbox gbxTips "" pos:[5,200] width:190 height:30
	
		HyperLink lnkLink "---  | 2019.9  miHoYo_Bullet.S |  - ï¼Ÿ --"
		color:(color 255 20 100) hovercolor:(color 255 0 255) visitedcolor:(color 255 20 100) \
		pos:[7,210] address:"https://acedocs.tk/"
		-- label labmiHoYo "--- TECH OTAKUS SAVE THE WORLD --" \
		-- pos:[7,210]

		-- timer tick_tock interval:666 active:iniHelpBtn
----------------------------------UIåŠä½œè€…ID------------------------------------------------
	fn fnRefreshMagicBtn =
	(
		if switchToolPanel == 0 then
		(
			rolloutBulletKeyTools.width               = 200
			rolloutBulletKeyTools.height              = 235
			rolloutBulletKeyTools.gbxMinTools.visible = false
			btnMagicBtn.text                          = "âœ§(â‰– â—¡ â‰–"
			btnMyScripts1.visible                     = false
			btnMyScripts2.visible                     = false
			btnMyScripts3.visible                     = false
			btnMyScripts4.visible                     = false
		)
		else
		(
			rolloutBulletKeyTools.width               = 365
			rolloutBulletKeyTools.height              = 255
			rolloutBulletKeyTools.gbxMinTools.visible = true
			btnMagicBtn.text                          = "( = `â–½`)"
			btnMyScripts1.visible                     = true
			btnMyScripts2.visible                     = true
			btnMyScripts3.visible                     = true
			btnMyScripts4.visible                     = true
		)
	)

	fn fnSwitchMagicBtn =
	(
		if switchToolPanel == 1 then
		(
			rolloutBulletKeyTools.width               = 200
			rolloutBulletKeyTools.height              = 235
			rolloutBulletKeyTools.gbxMinTools.visible = false
			btnMagicBtn.text                          = "âœ§(â‰– â—¡ â‰–"
			switchToolPanel                           = 0
			btnMyScripts1.visible                     = false
			btnMyScripts2.visible                     = false
			btnMyScripts3.visible                     = false
			btnMyScripts4.visible                     = false
		)
		else
		(
			rolloutBulletKeyTools.width               = 365
			rolloutBulletKeyTools.height              = 255
			rolloutBulletKeyTools.gbxMinTools.visible = true
			btnMagicBtn.text                          = "( = `â–½`)"
			switchToolPanel                           = 1
			btnMyScripts1.visible                     = true
			btnMyScripts2.visible                     = true
			btnMyScripts3.visible                     = true
			btnMyScripts4.visible                     = true
		)
	)

	fn fnSwitchToolsBtn idBtn =
	(
		arrToolC1 = #(rolloutBulletKeyTools.btnDelOutKeys,\
						rolloutBulletKeyTools.btnFastAlign,\
						rolloutBulletKeyTools.btnCopyKeyTools,\
						rolloutBulletKeyTools.btnAnimMirror,\
						rolloutBulletKeyTools.btnFnKeyType,\
						rolloutBulletKeyTools.btnNull1)
		arrToolC2 = #(rolloutBulletKeyTools.btnBoneTraj,\
						rolloutBulletKeyTools.btnBipedTraj,\
						rolloutBulletKeyTools.btnHideUnSel,\
						rolloutBulletKeyTools.btnQuickPrev,\
						rolloutBulletKeyTools.btnFnFrame,\
						rolloutBulletKeyTools.ckbFnMtlDisplay)
		arrToolC3 = #(rolloutBulletKeyTools.btnSelByColor,\
						rolloutBulletKeyTools.btnSelBoneBiped,\
						rolloutBulletKeyTools.btnCutSequence,\
						rolloutBulletKeyTools.btnMopherSlider,\
						rolloutBulletKeyTools.btnCSTools,\
						rolloutBulletKeyTools.btnPoseTool)
		arrToolC4 = #(rolloutBulletKeyTools.btnFnTCB,\
						rolloutBulletKeyTools.btnEulerFilter,\
						rolloutBulletKeyTools.btnEndBone,\
						rolloutBulletKeyTools.btnCleanOutKeys,\
						rolloutBulletKeyTools.btnNull2,\
						rolloutBulletKeyTools.btnBoneTool)
		-- arrToolC5 = #(rolloutBulletKeyTools.btnPoseTool,\
		-- 				rolloutBulletKeyTools.btnMopherSlider,\
		-- 				rolloutBulletKeyTools.btnCutSequence,\
		-- 				rolloutBulletKeyTools.btnImportOut,\
		-- 				rolloutBulletKeyTools.btnNull13,\
		-- 				rolloutBulletKeyTools.btnNiceSet)

		local arrBtnAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4
		
		for b in arrBtnAll do
		(
			b.visible = false
			-- b.width = 75
			-- b.height = 32
		)

		str  = "for b = 1 to arrToolC" + idBtn as string + ".count do" + "\r\n"
		str += "(" + "\r\n"
		str += "	arrToolC" + idBtn as string + "[b].visible = true" + "\r\n"
		str += "	arrToolC" + idBtn as string + "[b].pos = " + posToolBtn as string + " + [0,(b - 1) * 30]" + "\r\n"
		str += ")"
		
		execute str
	)

	fn fnSwitchToolBtnChecked Btn =
	(
		arrBtnTemp = #(ckbC1,ckbC2,ckbC3,ckbC4)
		for i = 1 to 4 do
		(
			if i != Btn then 
			(
				arrBtnTemp[i].checked = false
			)
			else 
			(
				idBtn = Btn
				arrBtnTemp[idBtn].checked = true
			)
		)
	)

	Fn fnCleanOutRangeKeys inputObject =  ---æ¸…ç†æ— é™å¸§,ä»¥å‰æ”¶é›†çš„,æ‰¾ä¸åˆ°æ¥æºäº†,å¤§æ¦‚æ˜¯éå†å­åŠ¨ç”»
	(
		startTime = AnimationRange.Start
		endTime = AnimationRange.End
		for i = 1 to inputObject.numSubs do
		(
			tempSubAnim = GetSubAnim inputObject i
			tempController = tempSubAnim.Controller
			
			if tempController != undefined do
			(
				tempKeyList = tempController.Keys
				
				outEndKeysIndex = for i = 1 to tempKeyList.Count where tempKeyList[i].Time > endTime collect i
				if outEndKeysIndex.Count > 0 do for i = 1 to outEndKeysIndex.Count do DeleteKey tempKeyList tempKeyList.count
				
				outStartKeysIndex = for i = 1 to tempKeyList.Count where  tempKeyList[i].Time < startTime collect i
				for i = 1 to outStartKeysIndex.Count do DeleteKey tempKeyList 1
			)
			if tempSubAnim.numSubs > 0 do fnCleanOutRangeKeys tempSubAnim
		)
	)

	fn fnDelSelKeys =
	(
		for o in selection where (o.ishidden == false) do 
		(
			if (classof o == Biped_Object) then
			(
				if classof o.controller == Vertical_Horizontal_Turn then  --æ¸…ç†è´¨å¿ƒå¸§
				(
					biped.deleteKeys o.controller.vertical #selection
					biped.deleteKeys o.controller.horizontal #selection
					if (sysinfo.GetMaxLanguage())[3]=="CHS" then 
						(biped.deleteKeys o.controller.flip #selection)
						else(biped.deleteKeys o.controller.turning #selection)
				)
				else if classof o.controller == BipSlave_Control then  --æ¸…ç†bipedæ­£å¸¸å¸§
				(
					biped.deleteKeys o.controller #selection
					subanimBipedScale = GetSubAnim o.controller[1] 1
					if ((subanimBipedScale != undefined) and \
					(GetSubAnimName subanimBipedScale 1 == #ScaleXYZ)) then  --æ¸…ç†bipedçš„ç¼©æ”¾é’ˆ
					(
						deleteKeys subanimBipedScale.controller #selection
					)
				)
			)
			else deleteKeys o #selection   ---æ¸…ç†ébipedå¸§
		)
	)

	-- fn fnAddLinkKeys tempObj =
	-- (
		fn fnAddLinkTimesKeys tempObj i=     --æ·»åŠ linkTimeså…³é”®å¸§
		(
			-- for i = 1 to tempObj.controller.numsubs do 
			-- (
				if ((GetSubAnimName tempObj.controller i) == #Link_Times) then
				(
					if tempObj.controller[i].keys[1] != undefined then
					(
						for i in tempObj.controller[i].keys do 
						(
							appendIfUnique arrLinkKeys i  ---------æ·»åŠ linkå¸§åˆ°æ•°ç»„
							appendIfUnique arrKeysTime i.time
							if i.selected == true then appendIfUnique arrKeysSelected i.time
						)
					)
				)
			-- )
		)
		fn fnAddLinkParamsKeys tempObj i=   ----æ·»åŠ LinkParamsä¸‹é¢çš„Transformå¸§
		(
			local tempLinkController
			local keyTimeStartTemp
			local keyTimeEndTemp
			
			-- for i = 1 to tempObj.controller.numsubs do 
			-- (
				if ((GetSubAnimName tempObj.controller i) == #Link_Params) then
				(
					tempLinkController = tempObj.controller[i]
					if tempLinkController[1] != undefined then
					(
						for i = 1 to tempLinkController.numsubs do -----linkå±æ€§çš„boneä¸‹é¢çš„prså¸§------
						(
							if (((tempLinkController[i]).name == "Position") or \
							((tempLinkController[i]).name == "Rotation") or \
							((tempLinkController[i]).name == "Scale")) then
							(
								if tempLinkController[i].keys[1] != undefined then
								(
									keyTimeStartTemp = tempLinkController[i].keys[1].time
									keyTimeEndTemp = tempLinkController[i].keys[tempLinkController[i].keys.count].time
									appendIfUnique arrKeysTime keyTimeStartTemp
									appendIfUnique arrKeysTime keyTimeEndTemp
									for i in tempLinkController[i].keys do 
									(
										if i.selected == true then appendIfUnique arrKeysSelected i.time
									)
								)
							)
						)
					)
				)
			-- )
		)
		-- fnAddLinkTimesKeys tempObj
		-- fnAddLinkParamsKeys tempObj
	-- )

	fn fnAddPrsKeys tempObj i=  ---------æ·»åŠ æ­£å¸¸ébipedçš„prså¸§(æ²¡åŠ link),iæ˜¯å­åŠ¨ç”»ID,åé¢ç”¨åˆ°,æå‰ä¼ å…¥å‡å°‘éå†
	(
		local keyTimeStartTemp
		local keyTimeEndTemp
		
		-- for i = 1 to tempObj.controller.numsubs do 
		-- (
			if (((tempObj.controller[i]).name == "Position") or \
			((tempObj.controller[i]).name == "Rotation") or \
			((tempObj.controller[i]).name == "Scale")) then
			(
				if tempObj.controller[i].keys[1] != undefined then
				(
					keyTimeStartTemp = tempObj.controller[i].keys[1].time
					keyTimeEndTemp = tempObj.controller[i].keys[tempObj.controller[i].keys.count].time
					appendIfUnique arrKeysTime keyTimeStartTemp
					appendIfUnique arrKeysTime keyTimeEndTemp
					for i in tempObj.controller[i].keys do 
					(
						if i.selected == true then appendIfUnique arrKeysSelected i.time
					)
				)
			)
		-- )
	)

	fn fnAddBipedKeys tempObj =------æ”¶é›†Bipedå¸§
	(
		local keyTimeStartTemp
		local keyTimeEndTemp
		local subanimBipedScale

		if classof tempObj.controller != Footsteps then
		(
			if classof tempObj.controller != Vertical_Horizontal_Turn then --ç­›é€‰å‡ºéè´¨å¿ƒçš„bipedå¸§
			(
				if (tempObj.controller.keys[1] != undefined) then
				(
					for i in tempObj.controller.keys do 
					(
						appendIfUnique arrKeysTime i.time   ---æ·»åŠ åˆ°æ•°ç»„
						if i.selected == true then appendIfUnique arrKeysSelected i.time
					)
				)
				subanimBipedScale = GetSubAnim tempObj.controller[1] 1
				if ((subanimBipedScale != undefined) and \
				(GetSubAnimName subanimBipedScale 1 == #ScaleXYZ)) then  ----ç­›é€‰å‡ºbipedçš„ç¼©æ”¾å¸§
				(
					if subanimBipedScale[1].keys[1] != undefined then
					(
						keyTimeStartTemp = subanimBipedScale[1].keys[1].time
						keyTimeEndTemp = subanimBipedScale[1].keys[subanimBipedScale[1].keys.count].time
						appendIfUnique arrKeysTime keyTimeStartTemp
						appendIfUnique arrKeysTime keyTimeEndTemp
						for i in subanimBipedScale[1].keys do 
						(
							if i.selected == true then appendIfUnique arrKeysSelected i.time
						)
					)
				)
			)
			else
			(-------------------ä¸‹é¢æ˜¯æ”¶é›†è´¨å¿ƒçš„å…³é”®å¸§,å‘åœ¨äºä¸­è‹±æ–‡turningåå­—è¿˜ä¸ä¸€æ ·...
				if classof tempObj.controller == Vertical_Horizontal_Turn then
				(
					bipCtrl = tempObj.controller
					vertCtrl = bipCtrl.vertical.controller
					horzCtrl = bipCtrl.horizontal.controller
					if (sysinfo.GetMaxLanguage())[3]=="CHS" then 
						(turnCtrl = bipCtrl.flip.controller)
						else(turnCtrl = bipCtrl.turning.controller)
					bipCtrlTemp = #(vertCtrl,horzCtrl,turnCtrl)
					for c in bipCtrlTemp do
					(
						if c.keys[1] != undefined then
						(
							keyTimeStartTemp = c.keys[1].time
							keyTimeEndTemp = c.keys[c.keys.count].time
							appendIfUnique arrKeysTime keyTimeStartTemp
							appendIfUnique arrKeysTime keyTimeEndTemp
							for i in c.keys do 
							(
								if i.selected == true then appendIfUnique arrKeysSelected i.time
							)
						)
					)
				)
			)
		)
	)

	fn fnAddKyes tempObj fnLink =   ---æ·»åŠ å¸§(ä¸»è¦æ˜¯é¦–å°¾å¸§),åŠ ä¸ªåˆ¤æ–­æ˜¯å¦å‹¾é€‰link
	(	
		if fnLink == 1 then ------1ä»£è¡¨å‹¾é€‰äº†link
		(
			if (classof tempObj != Biped_Object) then
			(
				if tempObj.controller != undefined then
				(
					if (classof tempObj.controller) == prs then
					(
						for i = 1 to tempObj.controller.numsubs do 
						(
							fnAddPrsKeys tempObj i        ---ébipedç‰©ä½“çš„ä½ç§»æ—‹è½¬ç¼©æ”¾å¸§
						)
					)
					if (classof tempObj.controller) == Link_Constraint then
					(
						for i = 1 to tempObj.controller.numsubs do 
						(
							fnAddLinkTimesKeys tempObj i         ---------linkå±æ€§çš„ç‰©ä½“linkå¸§å’Œélinkå¸§
							fnAddLinkParamsKeys tempObj i
						)
					)
				)
			)
			else
			(
				fnAddBipedKeys tempObj   ---------bipedå¸§
			)
		)
		if fnLink == 0 then  --------è·Ÿä¸Šé¢ä¸€æ ·,åŒºåˆ«åœ¨äºæ²¡æœ‰(linkå±æ€§ç‰©ä½“çš„linkå¸§)
		(
			if (classof tempObj != Biped_Object) then
			(
				if tempObj.controller != undefined then
				(
					if (classof tempObj.controller) == prs then
					(
						for i = 1 to tempObj.controller.numsubs do 
						(
							fnAddPrsKeys tempObj i
						)
					)
					if (classof tempObj.controller) == Link_Constraint then
					(
						for i = 1 to tempObj.controller.numsubs do 
						(
							fnAddLinkParamsKeys tempObj i
						)
					)
				)
			)
			else
			(
				fnAddBipedKeys tempObj   ---------bipedå¸§
			)
		)----------------æ”¶é›†å„ç§å¸§
		-- arrKeysTime = makeUniqueArray arrKeysTime  ---å»é™¤é‡å¤å¸§æ•°
		sort arrKeysTime  ----å¸§æ•°æ’åº
		sort arrKeysSelected
		if (arrKeysTime.count != 0) then
		(
			case of 
			(
				(arrKeysTime.count > 1):
				(
					keyFirst = arrKeysTime[1]            ------æ‰¾åˆ°é¦–å¸§
					keyEnd = arrKeysTime[arrKeysTime.count]   -----------æ‰¾åˆ°å°¾å¸§
				)
				(arrKeysTime.count == 1):   --é˜²æ­¢é¦–å°¾åŒå¸§çš„ä¿é™©
				(
					keyFirst = arrKeysTime[1]
					keyEnd = keyFirst + 1
				)
			)
		)
		if (arrKeysSelected.count != 0) then
		(
			case of 
			(
				(arrKeysSelected.count > 1):
				(
					keySelFirst = arrKeysSelected[1]            ------æ‰¾åˆ°é¦–å¸§
					keySelEnd = arrKeysSelected[arrKeysSelected.count]   -----------æ‰¾åˆ°å°¾å¸§
				)
				(arrKeysSelected.count == 1):   --é˜²æ­¢é¦–å°¾åŒå¸§çš„ä¿é™©
				(
					keySelFirst = arrKeysSelected[1]
					keySelEnd = keySelFirst + 1
				)
			)
		)
	)

	fn fnCollectKeys = ---------æ”¶é›†å…³é”®å¸§
	(
		arrKeysTime     = #()
		arrKeysSelected = #() ----------------å…ˆæ¸…ç©ºæ•°ç»„
		arrLinkKeys     = #()
		case of  -----------å¤„ç†é€‰ä¸­,æœªé€‰ä¸­åˆ™å¤„ç†å…¨éƒ¨
		(
			(selection.count == 0):
			(
				for i in (objects as array) where (i.ishidden == false) do 
				(
					if rolloutBulletKeyTools.btnJudgeLinkKey.checked == false then fnAddKyes i 0
					else 
					fnAddKyes i 1  -----------æ ¹æ®æ˜¯å¦å‹¾é€‰linkå¤„ç†æ”¶é›†å¸§
				)
			)
			default:
			(
				for i in (selection as array) where (i.ishidden == false) do 
				(
					if rolloutBulletKeyTools.btnJudgeLinkKey.checked == false then fnAddKyes i 0
					else 
					fnAddKyes i 1  -----------æ ¹æ®æ˜¯å¦å‹¾é€‰linkå¤„ç†æ”¶é›†å¸§
				)
			)
		)
	)
	
	fn fnChangetRangeTime =   ------------å…³é”®å¸§æ•°å­—éšæ»‘æ¡æ”¹å˜
	(
		rolloutBulletKeyTools.spiStartTime.value = animationrange.start
		rolloutBulletKeyTools.spiEndTime.value = animationrange.end
	)

	fn fnSelLinkKeys keyFirst KeyEnd symbol =  ---------------é€‰æ‹©linkå¸§æ–¹æ³•
	(
		if arrLinkKeys.count != 0 then
		(
			for i in arrLinkKeys do   -------linkå¸§é€‰ä¸­
			(
				i.selected = false ---å…ˆå–æ¶ˆä¹‹å‰linkå¸§é€‰ä¸­çŠ¶æ€
				case of  -------------åˆ¤æ–­linkå¸§ä½ç½®,æ•°å­—æ˜¯éšä¾¿å–çš„æ–¹ä¾¿åˆ¤æ–­æƒ…å†µ
				(
					(symbol == 0):(if i.time <= KeyEnd then i.selected = true)
					(symbol == 1):(if i.time >= keyFirst then i.selected = true)
					(symbol == 2):(i.selected = true)
				)
			)
		)
	)

	fn fnSelKeys keyFirst KeyEnd symbol =  ---------------é€‰æ‹©å¸§çš„æ–¹æ³•
	(
		fn fnSelectKeys keyFirst KeyEnd symbol =  -------å› ä¸ºæœ‰é€‰ä¸­å’Œæ²¡é€‰æ‹©çŠ¶æ€, æ‰€ä»¥åŠ ä¸€ä¸ªæ–¹æ³•ç²¾ç®€ä¸‹
		(
			for i in objects where (i.ishidden == false) do deselectKeys i          --æ¸…é™¤ä¹‹å‰é€‰ä¸­çš„å…³é”®å¸§
			if arrKeysTime.count != 0 then
			(
				selectkeys $ keyFirst KeyEnd  -------------é€‰ä¸­æ­£å¸¸å¸§
				if rolloutBulletKeyTools.btnJudgeLinkKey.checked == true then
				(
					fnSelLinkKeys keyFirst KeyEnd symbol --------------é€‰ä¸­linkå¸§
				)
			)
			else
			(
				if rolloutBulletKeyTools.btnJudgeLinkKey.checked == true then
				(
					fnSelLinkKeys keyFirst KeyEnd symbol
				)
			)
		)
		case of 
		(
			(selection.count == 0):  ----------åˆ¤æ–­æ˜¯å¦æœ‰é€‰ä¸­ç‰©ä½“
			(
				actionMan.executeAction 0 "40021"    ---æ²¡æœ‰é€‰æ‹©ç‰©ä½“åˆ™é€‰æ‹©æ‰€æœ‰ç‰©ä½“
				fnSelectKeys keyFirst KeyEnd symbol
			)
			default:  ----------------
			(
				fnSelectKeys keyFirst KeyEnd symbol
			)
		)
	)
	
	mapped fn fnMoveKeysAndLinkKeys obj offset =  ----https://forums.cgsociety.org/t/moving-keys-from-link-constraint-keys-access/1575053
	(
		local arrTargetID  = #()
		moveKeys obj offset #selection  ---å…ˆç§»åŠ¨élinkå¸§
		if rolloutBulletKeyTools.btnJudgeLinkKey.checked == true then 
		(
			if classof obj.controller == Link_Constraint do
			(
				nTargets = obj.controller.getNumTargets()  ---å¾—åˆ°linkçš„å¸§æ•°é‡
	
				if nTargets > 0 do
				(
					for i = nTargets to 1 by -1 do  ------å¦‚æœå¤§äº0åˆ™ä»æœ€ålinkå¸§å¼€å§‹ç§»
					(
						fNumber = obj.controller.getFrameNo i
						if ((fNumber >= keySelFirst) and (fNumber <= keySelEnd)) then
						(
							appendIfUnique arrTargetID i
						)
					)
					if offset > 0 then  --------åˆ¤æ–­å‘å‰è¿˜æ˜¯å‘åç§»åŠ¨å¸§
					(
						for i = arrTargetID.count to 1 by -1 do  ------å¦‚æœå¤§äº0åˆ™ä»æœ€ålinkå¸§å¼€å§‹ç§»
						(
							fNumber = obj.controller.getFrameNo arrTargetID[i]
							obj.controller.setFrameNo i (fNumber + offset)
						)
					)
					else
					(
						for i = 1 to arrTargetID.count do  ---å¦‚æœç§»åŠ¨å¸§å°äº0,ä»ç¬¬ä¸€ä¸ªlinkå¸§å¼€å§‹ç§»
						(
							fNumber = obj.controller.getFrameNo arrTargetID[i]
							obj.controller.setFrameNo i (fNumber + offset)
						)
					)
				)
			)
		)
	)

	-- fn fnSplitSelBiped = --åˆ†å¼€é€‰æ‹©å››è‚¢å’Œèº«ä½“,ä¾‹å¦‚åŒä¸€æ¡æ‰‹è‡‚åªé€‰æ‹©æœ€çˆ¶çº§çš„(æ–¹ä¾¿ç§»åŠ¨å¸§)
	-- (
	-- 	arrSelBiped = for i in selection where classof i.controller == BipSlave_Control collect i 

	-- )

	fn fnMoveBipedKeys offsetFrame =  -------ç§»åŠ¨Bipedå¸§
	(
		bipedRoot = #()   -------åˆ¤æ–­é€‰æ‹©äº†å‡ ä¸ªbipedéª¨æ¶
		for i in selection where ((classof i == Biped_Object) and (i.ishidden == false)) do  
		(
			appendIfUnique bipedRoot i.controller.rootNode  --æ·»åŠ åˆ°éª¨æ¶æ•°ç»„
		)
		for c in bipedRoot do  ---æŒ‰æ¯ä¸ªéª¨æ¶å¤„ç†
		(
			ctrlBiped = c.controller
			bipedAll = #(biped.getNode ctrlBiped #pelvis, -----å››è‚¢åŒå¸§å¤„ç†,åªå¤„ç†ä»–é¦–èŠ‚biped
						biped.getNode ctrlBiped #spine,
						biped.getNode ctrlBiped #neck,
						biped.getNode ctrlBiped #larm,
						biped.getNode ctrlBiped #rarm,
						biped.getNode ctrlBiped #lleg,
						biped.getNode ctrlBiped #rleg,
						biped.getNode ctrlBiped #prop1,
						biped.getNode ctrlBiped #prop2,
						biped.getNode ctrlBiped #prop3,
						biped.getNode ctrlBiped #tail)

			vertCtrl = ctrlBiped.vertical.controller  -----è´¨å¿ƒctrlå…³é”®å¸§
			horzCtrl = ctrlBiped.horizontal.controller
			if (sysinfo.GetMaxLanguage())[3]=="CHS" then 
			(turnCtrl = ctrlBiped.flip.controller)
			else(turnCtrl = ctrlBiped.turning.controller)
			bipCtrlTemp = #(vertCtrl,horzCtrl,turnCtrl)
			for c in bipCtrlTemp do
			(
				biped.moveKeys c offsetFrame #selection  -----ç§»åŠ¨é€‰å®šçš„è´¨å¿ƒå¸§
			)
			for nodeBiped in bipedAll where nodeBiped != undefined do  -----ç§»åŠ¨å…¶ä»–bipedçš„é€‰å®šå¸§
			(
				biped.moveKeys nodeBiped.controller offsetFrame #selection
			)
		)
	)		

	mapped fn fnMoveBipedScaleKeys tempObj offsetFrame =  -------ç§»åŠ¨bipedçš„ç¼©æ”¾å¸§
	(
		ctrlBiped = tempObj.controller
		if classof ctrlBiped == BipSlave_Control then  --------ä¸‹é¢åˆ¤å®šå­åŠ¨ç”»æ˜¯å¦ä¸ºscaleXYZ
		(
			if ((ctrlBiped[1][1] != undefined) and ((getSubAnimName ctrlBiped[1][1] 1) == #ScaleXYZ)) then
			(
				movekeys ctrlBiped[1][1][1] offsetFrame #selection
			)
		)
	)

	fn fnMoveAllKeys keyMovedOffset fnRange:off =
	(
		local rangEnd = animationrange.end
		local rangeStart = animationrange.start
		local n = 0  --næ¥åˆ¤å®šæ˜¯å¦æœ‰é€‰ä¸­biped

		if keyMovedOffset != undefined then
		(
			if selection.count != 0 then
			(
				for i in selection where (i.ishidden == false) do
				(
					if classof i != Biped_Object then
					(
						fnMoveKeysAndLinkKeys i keyMovedOffset
					)
					else 
					(
						fnMoveBipedScaleKeys i keyMovedOffset
						n += 1
					)
				)
				if n != 0 then  ----------åˆ†å¼€è§£å†³bipedå¤šç§»åŠ¨çš„é—®é¢˜,å‚»ç“œå¼æ–¹æ³•
				(
					fnMoveBipedKeys keyMovedOffset
				)
			)
			else  ---è·Ÿä¸Šé¢ä¸€æ ·,åªæ˜¯å¯¹æ‰€æœ‰ç‰©ä½“
			(
				for i in objects where (i.ishidden == false) do
				(
					if classof i != Biped_Object then
					(
						fnMoveKeysAndLinkKeys i keyMovedOffset
					)
					else fnMoveBipedScaleKeys i keyMovedOffset
				)
				fnMoveBipedKeys keyMovedOffset
			)
			if fnRange == on then
			(
				if keyMovedOffset > 0 then 
				(
					rangEnd = animationrange.end + keyMovedOffset
					animationrange = interval animationrange.start rangEnd
				)
				else if keyMovedOffset < 0 then 
				(
					rangeStart = animationrange.start + keyMovedOffset
					animationrange = interval rangeStart animationrange.end
				)
			)
			keySelFirst += keyMovedOffset
			keySelEnd  += keyMovedOffset
		)
	)

	fn fnAddTrajLayer =
	(
		if (LayerManager.getLayerFromName "Biped_Trajectories") != undefined then
		(
			layerTraj = LayerManager.getLayerFromName "Biped_Trajectories"
		)
		else layerTraj = LayerManager.newLayerFromName "Biped_Trajectories"
		layerTraj.lock = on
	)

	fn fnAddBipedTraj tempBiped =
	(
		pointTraj = point name:("Traj_" + tempBiped.name) size:0 cross:true 
		appendIfUnique arrTraj pointTraj
		freeze pointTraj
		arrBipedSonTemp = tempBiped.children
		bipedTarget = arrBipedSonTemp[(arrBipedSonTemp.count + 1)/2]
		pointTraj.transform = bipedTarget.transform
		pointTraj.parent = tempBiped
		layerTraj.addNode pointTraj
		deleteKeys pointTraj #allKeys
		pointTraj.showTrajectory = true
		-- ResetXForm pointTraj
	)

	fn fnDeleteTraj tempBiped =
	(
		local deleteTraj
		local deleteTrajName = ("Traj_" + tempBiped.name)
		local deleteTraArrID = findItem arrTraj deleteTrajName
		if deleteTraArrID != 0 then
		(
			deleteTraj = arrTraj[deleteTraArrID]
			deleteItem arrTraj deleteTraArrID
		)
		if (getNodeByName deleteTrajName) != undefined then (delete (getNodeByName deleteTrajName))
	)

	fn fnQuickSave =
	(
		local nameCurrentFile = getFilenameFile maxFileName
		local strNameSplit = "_Backup"
		local suffixFile = 1
		local fileSave = ""
		local arrFiles = #()
		local arrFilesNum = #()
		
		fn fnGetVerNum nameCurrentFile = 
		(
			numTempName = findstring nameCurrentFile "_Backup"
			numTempVer = substring nameCurrentFile (numTempName + 7) nameCurrentFile.count
			return numTempVer
		)

		if (matchPattern nameCurrentFile pattern:"*_Backup*" ignorCase:false) then
		(
			fnGetVerNum nameCurrentFile
			numTempName = findstring nameCurrentFile "_Backup"
			nameCurrentFile = substring nameCurrentFile 1 (numTempName - 1)
		)
		arrFiles = getfiles (maxFilePath + nameCurrentFile + "_Backup*.max")
		if arrFiles.count > 0 then
		(
			for i in arrFiles where (i != undefined) do
			(
				tempNum = ((fnGetVerNum (getFilenameFile i)) as integer)
				if tempNum != undefined then append arrFilesNum tempNum
				sort arrFilesNum
			)
			suffixFile = arrFilesNum[arrFilesNum.count] + 1
		)
		else suffixFile = 1
		fileSave = maxFilePath + nameCurrentFile + strNameSplit + (suffixFile as string) + ".max"
		saveMaxFile fileSave
	)

	fn fnCutDisplayKeyRange keyFirst keyEnd =  ---æ˜¾ç¤ºé¦–å°¾å¸§èŒƒå›´
	(
		if ((keyFirst != undefined) and (keyEnd != undefined)) then
		(
			if (arrKeysTime.count != 0) then
			(
				if (arrLinkKeys.count != 0) then
				(
					case of  ------ä¸‡æ¶çš„linkå¸§å¯¼è‡´æ›´å¤šåˆ¤å®š
					(
						((arrLinkKeys[1].time >= keyFirst) and (arrLinkKeys[arrLinkKeys.count].time <= keyEnd)):
						(animationrange = (interval keyFirst keyEnd))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time <= keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time keyEnd))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time >= keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time))
						((arrLinkKeys[1].time >= keyFirst) and (arrLinkKeys[arrLinkKeys.count].time > keyEnd)):
						(animationrange = (interval keyFirst arrLinkKeys[arrLinkKeys.count].time))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time > keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time))
					)
				)
				else
				(
					animationrange = interval keyFirst keyEnd
				)
			)
			else 
			(
				if ((arrLinkKeys.count != 0) and (arrLinkKeys.count > 1)) then 
				(
					animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time)
				)
				else 
				(
					if (arrLinkKeys.count == 1) then
					(
						animationrange = (interval arrLinkKeys[1].time (arrLinkKeys[1].time + 1))
					)
				)
			)
		)
	)

	fn fnHelpPosRange btnPos btnSize:[75,32] =
	(
		local mouseClientPos = mouse.screenPos - (getDialogPos rolloutBulletKeyTools) + uiClientOffsets
		-- local btnPos = pos
		-- local btnSize = [75,32]
		local btnBox = (Box2 btnPos.x btnPos.y btnSize.x btnSize.y)

		local dialogPos = getDialogPos rolloutBulletKeyTools
		local dialogBox = (Box2 dialogPos.x dialogPos.y \
			rolloutBulletKeyTools.width rolloutBulletKeyTools.height)
		return (contains btnBox mouseClientPos)
	)

	-- fn fnRefreshHelpText = 
	-- (
	-- 	if ((ckbHelpBtn.state) and (uiClientOffsets != undefined)) then 
	-- 	(
	-- 		posToolBtn1 = posToolBtn
	-- 		posToolBtn2 = posToolBtn + [0,32]
	-- 		posToolBtn3 = posToolBtn + [0,2 * 32]
	-- 		posToolBtn4 = posToolBtn + [0,3 * 32]
	-- 		posToolBtn5 = posToolBtn + [0,4 * 32]
	-- 		posToolBtn6 = posToolBtn + [0,5 * 32]

	-- 		if (fnHelpPosRange [245,26] btnSize:[90,192]) == true then 
	-- 		(
	-- 			if fnHelpPosRange posToolBtn1 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " å–æ¶ˆå…³é”®å¸§é€‰æ‹© ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " æ˜¾ç¤ºè½¨è¿¹  ||  æ¸…é™¤æ‰€æœ‰ ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " å†»ç»“æ˜¾ç¤ºæ¨¡å‹ ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " TCBå’Œæ¬§æ‹‰å±æ€§äº’è½¬ ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " Poseåº“ï¼Œè¦é¸½ ")
	-- 				)
	-- 			)
	-- 			if fnHelpPosRange posToolBtn2 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " åˆ é€‰æ‹©å¸§  ||  åˆ è½´å¤–å¸§ ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " åˆ‡æ˜¾å•ä¸ª  ||  åˆ‡æ˜¾æ‰€æœ‰ ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " æ ¹æ®é¢œè‰²é€‰æ‹©åŒè‰²ç‰©ä½“ ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " Boneè¿‡æ»¤æ¬§æ‹‰æ›²çº¿ ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " Mopherè¡¨æƒ…é€‰æ‹©æ»‘æ¡ ")
	-- 				)
	-- 			)
	-- 			if fnHelpPosRange posToolBtn3 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " æ–¹ä¾¿æ‹–å¸§å¹³æ»‘é¢„è§ˆ ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " Bipedéª¨éª¼ ||  Boneéª¨éª¼ ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " æ¸…é™¤æœ«ç«¯  ||  æ·»åŠ æœ«ç«¯ ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " åŠ¨ç”»ç‰‡æ–­æ ‡ç­¾ï¼Œè¦é¸½ ")
	-- 				)
	-- 			)
	-- 			if fnHelpPosRange posToolBtn4 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " Boneéª¨éª¼ ||  Bipedéª¨éª¼ ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " æ‰¹é‡å¯¼å…¥å¯¼å‡ºï¼Œè¦é¸½ ")
	-- 				)
	-- 			)
	-- 			if fnHelpPosRange posToolBtn5 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " Boxæ˜¾ç¤º   ||  Clayæ˜¾ç¤º ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ  ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " åŠŸèƒ½å¾…æ·»åŠ   ")
	-- 				)
	-- 			)
	-- 			if fnHelpPosRange posToolBtn6 == true then
	-- 			(
	-- 				case of 
	-- 				(
	-- 					(idBtn == 1):(gbxMinTools.caption = " æ‰¹é‡è½¬æ¢æ»‘åŠ¨å¸§ ")
	-- 					(idBtn == 2):(gbxMinTools.caption = " éšè—è´´å›¾ï¼Œé¢„è§ˆåŠ¨ç”» ")
	-- 					(idBtn == 3):(gbxMinTools.caption = " é€‰æ‹©CSéª¨éª¼å·¥å…· ")
	-- 					(idBtn == 4):(gbxMinTools.caption = " æ‰“å¼€BoneToolsé¢æ¿ ")
	-- 					(idBtn == 5):(gbxMinTools.caption = " å¿«æ·é”®ï¼Œå¤‡ä»½è®¾ç½® ")
	-- 				)
	-- 			)
	-- 		)
	-- 		else 
	-- 		(
	-- 			gbxMinTools.caption = " < å°å·¥å…·è¯´æ˜ > "
	-- 			myTimer.stop()
	-- 		)
	-- 	)
	-- )

	fn fnHidebyCategory cate:BoneGeometry =
	(
		if cate == BoneGeometry then
		(
			if switchHideBones == 0 then
			(
				for o in objects where ((classof o == BoneGeometry) and (o.isHidden == false)) do
				(
					append arrTempBones o
				)
				for b in arrTempBones do
				(
					b.isHidden = true
				)
				switchHideBones = 1
			)
			else if switchHideBones == 1 then
			(
				for b in arrTempBones do
				(
					b.isHidden = false
				)
				arrTempBones = #()
				switchHideBones = 0
			)
		)
		else
		(
			if switchHideBiped == 0 then 
			(
				for o in objects where ((classof o == Biped_Object) and (o.isHidden == false)) do
				(
					append arrTempBiped o
				)
				for b in arrTempBiped do
				(
					b.isHidden = true
				)
				switchHideBiped = 1
			)
			else if switchHideBiped == 1 then 
			(
				for b in arrTempBiped do
				(
					b.isHidden = false
				)
				arrTempBiped = #()
				switchHideBiped = 0
			)
		)
	)

	fn fnAddMyScript btnMyScript idMyScript =
	(
		dirScript = getOpenFileName caption:"è¯·é€‰æ‹©æ·»åŠ çš„Maxè„šæœ¬:" historyCategory:"myScripts" \
		types:"ms(*.ms)|*.ms|mse(*.mse)|*.mse|All(*.*)|*.*" filename:(getDir #scripts + @"\") 
		if (dirScript != undefined) then
		(
			nameMyScript = getFilenameFile dirScript
			btnMyScript.text = nameMyScript
			for i = 1 to iniArrMyScripts.count where iniArrMyScripts[i] != undefined do
			(
				if iniArrMyScripts[i].id == idMyScript then
				(
					deleteItem iniArrMyScripts i
				)
			)
			insertItem (myScript idMyScript nameMyScript dirScript) iniArrMyScripts idMyScript
		)
	)

	fn fnRefreshMyScripts =
	(
		arrMyScriptTemp = #(rolloutBulletKeyTools.btnMyScripts1,rolloutBulletKeyTools.btnMyScripts2,rolloutBulletKeyTools.btnMyScripts3,rolloutBulletKeyTools.btnMyScripts4)
		for b = 1 to 4 do 
		(
			if iniArrMyScripts[b] != undefined then
			(
				if (iniArrMyScripts[b].msName != undefined) then 
				(
					arrMyScriptTemp[b].text = iniArrMyScripts[b].msName
				)
				else arrMyScriptTemp[b].text = "<æœªå‘½åè„šæœ¬>"
			)
		)
	)

	on rolloutBulletKeyTools open do  ----æ‰“å¼€è„šæœ¬æ—¶æ“ä½œ
	(------åˆ·æ–°å›¾æ ‡, å›¾æ ‡æ˜¯maxè‡ªå¸¦çš„,ä¸»è¦æ˜¯æ‡’å¾—åš
		btnSelBeforeKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,3,3,3,3,true,true) 
		btnSelAfterKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,11,11,11,11,true,true) 
		btnSelAllKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,26,26,26,26,true,true)
		btnMoveKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,21,21,21,21,true,true)
-- 		btnMoveAfterKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,13,13,13,13,true,true)
		-- dotnet.AddEventHandler myTimer #elapsed fnRefreshHelpText
		-- myTimer.Start()
		-- ckbHelpBtn.checked = iniHelpBtn
		timeDIsTemp      = timeDisplayMode  ----å°æ•°å¸§è¿˜æ˜¯æ•´æ•°å¸§
		-- iniPos = (GetDialogPos rolloutBulletKeyTools) 
		fnSaveConfig ()  ---------------è„šæœ¬ä½ç½®èµ‹å€¼
		fnSetConfig ()  ----------------ä¿å­˜ä½ç½®ä¿¡æ¯åˆ°iniæ–‡ä»¶
		registerTimeCallback fnChangetRangeTime  -------------å¸§èŒƒå›´æ”¹å˜æ·»åŠ å›è°ƒ
		rolloutBulletKeyTools.gbxMinTools.visible  = false
		fnRefPlaySpeedValue ()  -----åˆ¤æ–­æ’­æ”¾é€Ÿåº¦
		rolloutBulletKeyTools.btnSetFpsAndSpeed.text = " |  " + strCurrentFps + "  | " + valuePlaySpeed + " |"
		fnRefreshMagicBtn ()
		fnSwitchToolsBtn idBtn
		fnSwitchToolBtnChecked idBtn
		fnRefreshMyScripts ()
	)
	
	on rolloutBulletKeyTools close do -- å…³é—­è®°å¿†æµ®åŠ¨çª—å£ä½ç½®
	(
		iniPos = (GetDialogPos rolloutBulletKeyTools)
		fnSetConfig ()
	)
	-----------------------------------------------------------------------------------------
	on rolloutBulletKeyTools mbuttondown pos do 
	(
		try (destroydialog rolloutBulletKeyTools) catch ()
	)
	
	on rolloutBulletKeyTools lbuttondown posMou do
	(
		posMouMoved = posMou
		switchMouseState = on
	)
	
	on rolloutBulletKeyTools lbuttonup posMou do
	(
		switchMouseState = off
	)
	
	on rolloutBulletKeyTools mouseMove pos do
	(
		-- myTimer.Start()
		if switchMouseState == on then
		(
			SetDialogPos rolloutBulletKeyTools (mouse.screenpos - posMouMoved)			
		)
		if (uiClientOffsets == undefined) then 
		(
			uiClientOffsets = pos - (mouse.screenPos - (getDialogPos rolloutBulletKeyTools)) 
		)
	)

	-- on tick_tock tick do
	-- (
	-- 	fnRefreshHelpText ()
	-- )
	---------------------ä¸Šé¢è®¾ç½®æ‹–åŠ¨è„šæœ¬çª—å£,å»æ‰æ ‡é¢˜æ åé»˜è®¤æ— æ³•æ‹–åŠ¨---------------------
	on btnSelBoneBiped pressed do ----é€‰æ‹©boneæˆ–è€…biped
	(
		clearselection ()
		for o in objects where (o.ishidden == false) do 
		(
			if classof o == Biped_Object then selectmore o
		)
	)

	on btnSelBoneBiped rightclick do ----é€‰æ‹©boneæˆ–è€…biped
	(
		clearselection ()
		for o in objects where (o.ishidden == false) do 
		(
			if classof o == BoneGeometry then selectmore o
		)
	)

	on spiStartTime changed valTime do  --------åˆå§‹å¸§å®šä½åˆ°è¾“å…¥çš„å¸§æ•°
	(		
		local rangeStart = valTime as time
		if ((valTime != ".") and (valTime as time != undefined) and \
		(valTime != "") and (rangeStart < animationrange.end)) then
		(
			animationrange = (interval rangeStart animationrange.end)
		)
		else messageBox "----------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§æ•°!"
	)

	on spiEndTime changed valTime do  --------åˆå§‹å¸§å®šä½åˆ°è¾“å…¥çš„å¸§æ•°
	(		
		local rangEnd = valTime as time
		if ((valTime != ".") and (valTime as time != undefined) and \ 
		(valTime != "") and (rangEnd > animationrange.start)) then
		(
			animationrange = (interval animationrange.start rangEnd)
		)
		else messageBox "----------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§æ•°!"
	)
	
	on btnFnFrame pressed do  -------------åˆ‡æ¢æ•´æ•°å¸§å°æ•°å¸§,æ–¹ä¾¿æ‹–åŠ¨æ»‘æ¡å¹³æ»‘é¢„è§ˆ
	(
		if timeDisplayMode != #frameTicks then 
		(
			timeDisplayMode = #frameTicks
		)
		else 
		(
			timeDisplayMode = #frames
		)
		slidertime -= 1
		slidertime += 1  ----------é»˜è®¤æ”¹äº†è¦åˆ’ä¸€ä¸‹æ»‘æ¡æ‰ç”Ÿæ•ˆ,è„šæœ¬ç›´æ¥æ“ä½œäº†~~æ²¡æ‰¾åˆ°refreshçš„
	)
	
	on btnMagicBtn pressed do  -------------åˆ‡æ¢æ•´æ•°å¸§å°æ•°å¸§,æ–¹ä¾¿æ‹–åŠ¨æ»‘æ¡å¹³æ»‘é¢„è§ˆ
	(
		fnSwitchMagicBtn ()
	)

	-- on ckbHelpBtn changed state do 
	-- (
	-- 	iniHelpBtn = state
	-- 	if state == off then 
	-- 	(
	-- 		gbxMinTools.caption = " < å°å·¥å…·è¯´æ˜ > "
	-- 		-- tick_tock.active = false
	-- 	)
	-- 	-- else tick_tock.active = true
	-- )

	on btnCSTools pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\cstools.ms")
	)
	on btnSpringMagic pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\SpringMagic_New.mse")
	)
	on btnSpringMagic rightclick do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\SpringMagic_Old.mse")
	)

	on btnFileOpen pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts" + "\\BsOpenTools.ms")
	)

	on btnBoneTraj pressed do ------æ˜¾ç¤ºboneçš„è½¨è¿¹
	(
		for i in (selection as array) where (classof i != Biped_Object) do
		(
			if i.showtrajectory == true then i.showtrajectory = false
			else i.showtrajectory = true
		)
	)

	on btnBoneTraj rightclick do   ----å³é”®å–æ¶ˆboneçš„è½¨è¿¹æ˜¾ç¤º
	(
		for i in (objects as array) where (classof i != Biped_Object) do
		(
			if i.showtrajectory == true then i.showtrajectory = false
		)
	)

	on btnBipedTraj pressed do 
	(
		fnAddTrajLayer () ----æ˜¯å¦åˆ›å»ºè½¨è¿¹å±‚
		if (selection.count > 1) then
		(
			for i in (selection as array) do
			(
				if classof i == Biped_Object then
				(
					if (getNodeByName ("Traj_" + i.name)) != undefined then 
					(
						fnDeleteTraj i
					)
				)
			)
		)
		else if selection.count == 1 then
		(
			if classof $ == Biped_Object then
				(
					if (getNodeByName ("Traj_" + $.name)) != undefined then 
					(
						fnDeleteTraj $
					)
					else fnAddBipedTraj $
				)
		)
	)

	on btnBipedTraj rightclick do
	(
		delLayerObj = #()

		delLayer    = LayerManager.getLayerFromName "Biped_Trajectories"
		
		if delLayer != undefined then
		(
			layerRT = delLayer.layerAsRefTarg
			delLayerObj = refs.dependents layerRT
			delLayer.lock = off
			for i in delLayerObj where ((delLayerObj.count != 0) and (classof i == point)) do delete i
			LayerManager.deleteLayerByName "Biped_Trajectories"
			delLayerObj = #()
		)
	)

	-- on btnBipedTraj rightclick do
	-- (
	-- 	-- bipedRoot = #()   -------åˆ¤æ–­é€‰æ‹©äº†å‡ ä¸ªbipedéª¨æ¶
	-- 	if (selection.count > 0) then
	-- 	(
	-- 		-- for i in (selection as array) where classof i == Biped_Object do  
	-- 		-- (
	-- 		-- 	appendIfUnique bipedRoot i.controller.rootNode  --æ·»åŠ åˆ°éª¨æ¶æ•°ç»„
	-- 		-- )
	-- 		for i in (selection as array) do 
	-- 		(
	-- 			if (classof i == Biped_Object) then
	-- 			(
	-- 				nodeTemp = i.controller.rootNode
	-- 				trajDisFn = nodeTemp.controller.displayTrajectories
	-- 				if trajDisFn == true then nodeTemp.controller.displayTrajectories = false
	-- 				else nodeTemp.controller.displayTrajectories = true
	-- 				exit
	-- 			)
	-- 		)
	-- 	)
	-- )

	on edtMoveKey entered val do   -----ç§»åŠ¨å¸§æ•°è‡ªå®šä¹‰,è¾“å…¥å³å¯
	(
		if ((val != ".") and (val as time != undefined) and (val != "")) then
		(------"."ä»–ä¹Ÿè®¤ä¸ºæ˜¯æ•°å­—...
			keyMovedOffset = val as integer
			rolloutBulletKeyTools.edtMoveKey.text = keyMovedOffset as string + "f"
		)
		else messageBox "----------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§æ•°!"
	)

	on btnSet5 pressed do 
	(
		edtMoveKey.text = "5f"
		keyMovedOffset = 5
	)
	on btnSetAdd pressed do 
	(
		edtMoveKey.text = "+5f"
		keyMovedOffset += 5
		edtMoveKey.text = keyMovedOffset as string + "f"
	)
	on btnSetOpposite pressed do
	(
		keyMovedOffset = - keyMovedOffset
		edtMoveKey.text = keyMovedOffset as string + "f"
	)
	on btnMoveKeys pressed do with undo on   ------ç§»åŠ¨é€‰å®šå¸§
	(
		fnMoveAllKeys keyMovedOffset fnRange:off
	)
	on btnMoveKeys rightclick do with undo on
	(
		fnMoveAllKeys keyMovedOffset fnRange:on
	)
	on btnSelBeforeKeys pressed do  ------------é€‰æ‹©æ»‘æ¡ä¹‹å‰å¸§
	(
		symbol = 0
		fnCollectKeys ()
		if arrLinkKeys.count != 0 then
		(
			for i in arrLinkKeys do i.selected = false
		)
		if arrKeysTime.count != 0 then
		(
			if keyFirst <= sliderTime then 
			(
				fnSelKeys keyFirst sliderTime symbol
			)
			else 
			(
				fnSelKeys sliderTime sliderTime symbol
			)
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				if arrLinkKeys[1].time <= sliderTime then 
				(
					fnSelLinkKeys arrLinkKeys[1].time sliderTime symbol
				)
				else 
				(
					fnSelLinkKeys sliderTime sliderTime symbol
				)
			)
		)
	)
	
	on btnSelAfterKeys pressed do  -------------é€‰æ‹©æ»‘æ¡ä¹‹åå¸§
	(
		symbol = 1
		fnCollectKeys ()
		if arrKeysTime.count != 0 then
		(
			if arrLinkKeys.count != 0 then
			(
				for i in arrLinkKeys do i.selected = false
			)
			if keyEnd >= sliderTime then 
			(
				fnSelKeys sliderTime keyEnd symbol
			)
			else 
			(
				fnSelKeys sliderTime sliderTime symbol
			)
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				if arrLinkKeys[1].time >= sliderTime then 
				(
					fnSelLinkKeys sliderTime arrLinkKeys[1].time symbol
				)
				else 
				(
					fnSelLinkKeys sliderTime sliderTime symbol
				)
			)
		)
	)
	
	on btnSelAllKeys pressed do     ------------------é€‰æ‹©æ‰€æœ‰å¸§
	(
		symbol = 2
		fnCollectKeys ()
		if arrKeysTime.count != 0 then
		(
			fnSelKeys keyFirst keyEnd symbol
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				fnSelLinkKeys arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time symbol
			)
		)
	)
	
	on btnSetFpsAndSpeed pressed do popupMenu menuSetFps
		
	on btnSetFpsAndSpeed rightclick do popupMenu menuSetSpeed

	-- on btnClearSelKeys pressed do  ---------------------æ¸…é™¤å¸§é€‰æ‹©
	-- (
	-- 	fnCollectKeys ()
	-- 	if arrKeysTime.count != 0 then  ----æ¸…é™¤élinkå¸§
	-- 	(
	-- 		for i in objects where (i.ishidden == false) do 
	-- 		(
	-- 			deselectKeys i
	-- 			if classof i == Biped_Object then
	-- 			(
	-- 				ctrlBiped      = i.controller
	-- 				numLayers      = biped.numLayers ctrlBiped
	-- 				idCurrentLayer = biped.getCurrentLayer ctrlBiped
	-- 				while numLayers >= 0 do
	-- 				(
	-- 					biped.setCurrentLayer ctrlBiped numLayers
	-- 					deselectKeys i
	-- 					numLayers -= 1
	-- 				)
	-- 				biped.setCurrentLayer ctrlBiped idCurrentLayer
	-- 			)
	-- 		)
	-- 		if arrLinkKeys.count != 0 then
	-- 		(
	-- 			for i in arrLinkKeys do i.selected = false
	-- 		)
	-- 	)
	-- 	else
	-- 	(
	-- 		if arrLinkKeys.count != 0 then  ---æ¸…é™¤linkå¸§
	-- 		(
	-- 			for i in arrLinkKeys do i.selected = false
	-- 		)
	-- 	)
	-- )
	
	on btnJudgeLinkKey changed state do   --åˆ‡æ¢æ˜¯å¦å‹¾é€‰link
	(
		if btnJudgeLinkKey.state == false then
		(
			if arrLinkKeys.count != 0 then
			(
				for i in arrLinkKeys do i.selected = false
			)
		)
		else fnCollectKeys ()
	)

	on btnCleanOutKeys pressed do with undo on-----------æ¸…ç†èŒƒå›´å¤–å¸§(æ— é™å¸§)
	(
		if (selection as array).count == 0 then 
		(
			for tempObject in (objects as Array) do fnCleanOutRangeKeys tempObject
		)
		else
		(
			for tempObject in (selection as Array) do fnCleanOutRangeKeys tempObject
		)
	)

	on btnDelOutKeys pressed do with undo on-----------æ¸…ç†é€‰æ‹©å¸§
	(
		fnDelSelKeys ()
	)

	on btnDelOutKeys rightclick do with undo on-----------æ¸…ç†é€‰æ‹©å¸§
	(
		actionMan.executeAction 0 "40021"  -- Selection: Select All
		fnCollectKeys ()
		fnSelKeys keyFirst keyEnd 2
		fnDelSelKeys ()
		if arrLinkKeys.count != 0 then
		(
			fnSelLinkKeys arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time 2
		)
	)

	on btnHideBones pressed do
	(
-- 		if hideByCategory.bones == false then 
-- 		(
-- 			hideByCategory.bones = true
-- 			btnHideBones.text = "â˜€ æ˜¾ç¤ºéª¨éª¼"
-- 		)
-- 		else 
-- 		(
-- 			hideByCategory.bones = false
-- 			btnHideBones.text = "â˜ éšè—éª¨éª¼"
-- 		)
-- 		redrawviews()
-- 		slidertime -= 1
-- 		slidertime += 1
		fnHidebyCategory cate:BoneGeometry
	)
	
	on btnHideBones rightclick do
	(
		fnHidebyCategory cate:Biped_Object
	)

	on ckbFreezeMesh changed state do 
	(
		if state == on then
		(
			for o in objects where (((classof o == Editable_mesh) \
			or (classof o == Editable_Poly) or (classof o == PolyMeshObject)) \
			and (o.isHidden == false)) do
			(
				freeze o
				o.showFrozenInGray = off
			)
			ckbFreezeMesh.text = "â˜€ è§£å†»æ¨¡å‹"
		)
		else
		(
			for o in objects where (((classof o == Editable_mesh) \
			or (classof o == Editable_Poly) or (classof o == PolyMeshObject)) \
			and (o.isHidden == false)) do
			(
				unfreeze o
				o.showFrozenInGray = off
			)
			ckbFreezeMesh.text = "âœ² å†»ç»“æ¨¡å‹"
		)
	)

	on btnQuickSave pressed do 
	(
		if maxFilePath == "" then 
		(
			messagebox "------------------------------------\r\nå½“å‰åœºæ™¯æœªä¿å­˜è¿‡,\r\nè¯·å…ˆå³é”®ç‚¹å‡»ä¿å­˜åˆå§‹ç‰ˆæœ¬~"
		)
		else fnQuickSave ()
	)
	on btnQuickSave rightclick do 
	(
		max file saveas
	)

	on btnCutFrameDisplay pressed do with undo on  ---------------å¸§æ æ˜¾ç¤ºé¦–å°¾å¸§èŒƒå›´
	(
		if switchSelKeyRange == 0 then
		(
			fnCollectKeys ()
			arrLastSelRange = #(animationrange.start,animationrange.end)
			fnCutDisplayKeyRange keySelFirst keySelEnd
			switchSelKeyRange = 1
		)
		else 
		(
			animationrange = interval arrLastSelRange[1] arrLastSelRange[2]
			switchSelKeyRange = 0
			arrLastSelRange = #()
		)
	)
	on btnCutFrameDisplay rightclick do with undo on  ---------------å¸§æ æ˜¾ç¤ºé¦–å°¾å¸§èŒƒå›´
	(
		if switchAllKeyRange == 0 then
		(
			fnCollectKeys ()
			arrLastAllRange = #(animationrange.start,animationrange.end)
			fnCutDisplayKeyRange keyFirst keyEnd
			switchAllKeyRange = 1
		)
		else 
		(
			animationrange = interval arrLastAllRange[1] arrLastAllRange[2]
			switchAllKeyRange = 0
			arrLastAllRange = #()
		)
	)

	------------åˆ‡æ¢å·¥å…·æ åˆ†ç±»--------------------------------------------
	on ckbC1 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 1
			fnSwitchToolsBtn 1
		)
		else ckbC1.checked = true
	)
	on ckbC2 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 2
			fnSwitchToolsBtn 2
		)
		else ckbC2.checked = true
	)
	on ckbC3 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 3
			fnSwitchToolsBtn 3
		)
		else ckbC3.checked = true
	)
	on ckbC4 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 4
			fnSwitchToolsBtn 4
		)
		else ckbC4.checked = true
	)
	-- on ckbC5 changed state do 
	-- (
	-- 	if state == true then 
	-- 	(
	-- 		fnSwitchToolBtnChecked 5
	-- 		fnSwitchToolsBtn 5
	-- 	)
	-- 	else ckbC5.checked = true
	-- )
	--------------------------------------------------------------------

	on btnFnTCB pressed do 
	(
		for i in selection where classof i == BoneGeometry do
		(
			if classof i.rotation.controller == tcb_rotation then
				(i.rotation.controller = Euler_XYZ ())
				else (i.rotation.controller = tcb_rotation ())
		)
	)

	-- on btnBoneTool pressed do (macros.run "Animation Tools" "BoneAdjustmentTools")

	on btnBoneTool pressed do 
	(
		for i in selection where classof i == BoneGeometry do
		(
			if i.boneEnable == false then i.boneEnable = true
			else i.boneEnable = false
		)
	)
	
	on btnFnKeyType pressed do 
	(
		try(destroydialog rolFnKeys)catch()
		Createdialog rolFnKeys  fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)

	on btnEulerFilter pressed do 
	(
		for i in selection where classof i == BoneGeometry do
		(
			if classof i.rotation.controller == Euler_XYZ then
			(
				i.rotation.controller = tcb_rotation ()
				i.rotation.controller = Euler_XYZ ()
			)
		)
	)

	on ckbFnBoxDisplay changed state do 
	(
		for o in Geometry where (o.isHidden == false) do 
		(
			if ((classof o == BoneGeometry) or (classof o == Biped_Object)) then
			(
				if state == on then o.boxmode = on 
				else o.boxmode = off
			)
		)
	)
	
	on ckbFnMtlDisplay changed state do 
	(
		if state == off then
		(
			-- for mat in (getClassInstances vrayMtl processAllAnimatables:true) do showTextureMap mat on
			for mat in (getClassInstances standard processAllAnimatables:true) do showTextureMap mat on
		)
		else
		(
			-- for mat in (getClassInstances vrayMtl processAllAnimatables:true) do showTextureMap mat off
			for mat in (getClassInstances standard processAllAnimatables:true) do showTextureMap mat off
		)
	)

	on ckbFnMtlDisplay rightclick do 
		(
			local disp = NitrousGraphicsManager.GetActiveViewportSetting() 
			if disp.VisualStyleMode == #clay then disp.VisualStyleMode = #Realistic
			else disp.VisualStyleMode =  #clay
		)

	on btnMopherSlider pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\MorphSliders_11.ms")
		macros.run "Tools" "MorphSliders"
	)

	on btnCopyKeyTools pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\æš´åŠ›å¸§æ‹·è´ç²˜è´´è„šæœ¬.mse")
	)

	on btnAnimMirror pressed do 
	(
		FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\åŠ¨ç”»é•œåƒå·¥å…·.mse")
	)

	on btnMyScripts1 pressed do 
	(
		if ((iniArrMyScripts[1] != undefined) and (doesfileexist iniArrMyScripts[1].dir)) then 
		(
			fileIn iniArrMyScripts[1].dir
		)
		else fnAddMyScript btnMyScripts1 1
	)
	on btnMyScripts2 pressed do 
	(
		if ((iniArrMyScripts[2] != undefined) and (doesfileexist iniArrMyScripts[2].dir)) then 
		(
			fileIn iniArrMyScripts[2].dir
		)
		else fnAddMyScript btnMyScripts2 2
	)
	on btnMyScripts3 pressed do 
	(
		if ((iniArrMyScripts[3] != undefined) and (doesfileexist iniArrMyScripts[3].dir)) then 
		(
			fileIn iniArrMyScripts[3].dir
		)
		else fnAddMyScript btnMyScripts3 3
	)
	on btnMyScripts4 pressed do 
	(
		if ((iniArrMyScripts[4] != undefined) and (doesfileexist iniArrMyScripts[4].dir)) then 
		(
			fileIn iniArrMyScripts[4].dir
		)
		else fnAddMyScript btnMyScripts4 4
	)
	on btnMyScripts5 pressed do 
	(
		if ((iniArrMyScripts[5] != undefined) and (doesfileexist iniArrMyScripts[5].dir)) then 
		(
			fileIn iniArrMyScripts[5].dir
		)
		else fnAddMyScript btnMyScripts5 5
	)

	on btnMyScripts1 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)
	on btnMyScripts2 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)
	on btnMyScripts3 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)
	on btnMyScripts4 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:(color 255 20 100) \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)

	on btnHideUnSel pressed do 
	(
		arrTemp = objects as array
		arrTempAllObj = for o in arrTemp where o.isHidden == false collect o
		numTempCurrentSel = selection.count
		if arrTempAllObj.count > numTempCurrentSel then
		(
			if numTempCurrentSel != 0 then 
			(
				arrTempSelObj = selection as array
			)
			for i in arrTempSelObj where (arrTempSelObj.count != 0) do
			(
				num = finditem arrTempAllObj i
				if num != 0 then deleteItem arrTempAllObj num
			)
			arrTempUnSelection = arrTempAllObj
			actionMan.executeAction 0 "281"
		)
	)

	on btnHideUnSel rightclick do
	(
		if arrTempUnSelection.count != 0 then
		(
			for i in arrTempUnSelection do i.isHidden = false
		)
	)

	on btnQuickPrev pressed do 
	(
		createPreview percentSize:100 \
		dspGeometry:true dspShapes:false dspLights:false \
		dspCameras:false dspHelpers:false dspParticles:true dspBones:false \
		dspGrid:true dspSafeFrame:false dspFrameNums:false dspBkg:true \
		rndLevel:#smoothhighlights
	)

	on btnQuickPrev rightclick do 
	(
		shellLaunch (getdir #preview) ""
	)

	on btnSelByColor pressed do
	(
		for i in selection as array where (i.ishidden == false) do
		(
			for o in objects as array where (i.ishidden == false) do
			(
				if o.wirecolor == i.wirecolor then selectmore o
			)
		)
	)
)
Createdialog rolloutBulletKeyTools fgcolor:(color 255 20 100) pos:iniPos style:#()
clearListener()  ---------æ¸…é™¤ä¾¦å¬å™¨


------------------------toolbar----------------------------------------------------
macroScript BulletKeyTools
category:"_[BulletTools]"
buttonText:"Kå¸§å·¥å…·"
toolTip:"Kå¸§å·¥å…·"
-- Icon:#("Systems",2)
(
	on execute do
	(
		fileIn ((getDir #Scripts)+ "\\BulletScripts\\" + "BulletKeyTools.ms")
	)
)
-------------------------------------------------------------------------------------